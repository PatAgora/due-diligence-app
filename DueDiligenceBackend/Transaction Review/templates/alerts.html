{% extends "base.html" %}
{% block title %}Alerts{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h2 class="fw-bold mb-3">Alerts</h2>

  <!-- Filters -->
  <form class="card mb-4" method="get" action="{{ url_for('alerts') }}">
    <!-- keep currently selected customer when applying filters -->
    <input type="hidden" name="customer_id" value="{{ request.args.get('customer_id','') }}">
    <div class="card-body">
      <div class="row g-3 align-items-end">

        <!-- Severity -->
        <div class="col-sm-3 col-md-2">
          <label for="severity" class="form-label">Severity</label>
          {% set sev = request.args.get('severity', '') %}
          <select id="severity" name="severity" class="form-select">
            <option value="" {{ 'selected' if not sev }}>All</option>
            <option value="CRITICAL" {{ 'selected' if sev=='CRITICAL' }}>Critical</option>
            <option value="HIGH"     {{ 'selected' if sev=='HIGH' }}>High</option>
            <option value="MEDIUM"   {{ 'selected' if sev=='MEDIUM' }}>Medium</option>
            <option value="LOW"      {{ 'selected' if sev=='LOW' }}>Low</option>
            <option value="INFO"     {{ 'selected' if sev=='INFO' }}>Info</option>
          </select>
        </div>

        <!-- Tags -->
        <div class="col-sm-5 col-md-3">
          <label for="tag" class="form-label">Tags</label>
          {% set sel_tag = request.args.get('tag', '') %}
          {% set fallback_tags = [
            'PROHIBITED_COUNTRY','HIGH_RISK_COUNTRY','HISTORICAL_DEVIATION','NLP_RISK',
            'EXPECTED_BREACH_OUT','EXPECTED_BREACH_IN','CASH_DAILY_BREACH'
          ] %}
          {% set tags_list = available_tags if (available_tags is defined and available_tags) else fallback_tags %}
          <select id="tag" name="tag" class="form-select">
            <option value="" {{ 'selected' if not sel_tag }}>All</option>
            {% for t in tags_list %}
              <option value="{{ t }}" {{ 'selected' if sel_tag==t }}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary mt-4 flex-shrink-0">Apply filters</button>
          <!-- Clear but keep customer context -->
          <a class="btn btn-outline-secondary mt-4"
             href="{{ url_for('alerts', customer_id=request.args.get('customer_id','')) }}">Clear</a>
        </div>
      </div>
    </div>
  </form>

  <!-- Results table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col" style="white-space:nowrap;">Date</th>
              <th scope="col" style="white-space:nowrap;">Txn ID</th>
              <th scope="col">Customer</th>
              <th scope="col">Country</th>
              <th scope="col" class="text-end" style="width: 90px;">Score</th>
              <th scope="col" style="white-space:nowrap;">Severity</th>
              <th scope="col">Reasons</th>
              <th scope="col">Tags</th>
              <th scope="col" style="white-space:nowrap;">Created</th>
            </tr>
          </thead>
          <tbody>
          {% if alerts and alerts|length %}
            {% for a in alerts %}
              <tr>
                <td style="white-space:nowrap;">{{ a.txn_date }}</td>
                <td style="white-space:nowrap;">{{ a.txn_id }}</td>
                <td>
                  {% set cust = a.customer_id %}
                  <a href="{{ url_for('explore', customer_id=cust) }}" class="text-decoration-none">
                    {{ cust }}
                  </a>
                </td>
                <td style="white-space:nowrap;">{{ a.country_iso2 or '—' }}</td>
                <td class="text-end">{{ a.score }}</td>
                <td style="white-space:nowrap;">
                  {% set s = (a.severity or '').upper() %}
                  {% if s == 'CRITICAL' %}
                    <span class="badge bg-danger">CRITICAL</span>
                  {% elif s == 'HIGH' %}
                    <span class="badge bg-warning text-dark">HIGH</span>
                  {% elif s == 'MEDIUM' %}
                    <span class="badge bg-info text-dark">MEDIUM</span>
                  {% elif s == 'LOW' %}
                    <span class="badge bg-success">LOW</span>
                  {% else %}
                    <span class="badge bg-secondary">INFO</span>
                  {% endif %}
                </td>
                <td class="text-muted">
                  {{ a.reasons }}
                </td>
                <td style="white-space:nowrap;">
                  {% for t in (a.rule_tags.split(',') if a.rule_tags else []) %}
                    <span class="badge bg-light text-dark border me-1">{{ t.strip() }}</span>
                  {% endfor %}
                </td>
                <td style="white-space:nowrap;">{{ a.created_at[:19] if a.created_at else '—' }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-5">
                No alerts match the current filters.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}