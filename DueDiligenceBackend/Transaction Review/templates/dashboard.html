{% extends "base.html" %}
{% block content %}
<h2 class="fw-bold mb-3">Transaction Dashboard</h2>

{% if not filter_meta or not filter_meta.customer_id %}
  <!-- Empty state until a customer is searched -->
  <div class="card">
    <div class="card-body d-flex align-items-center justify-content-between">
      <div>
        <h5 class="mb-1">Search for a customer to begin</h5>
        <p class="text-muted mb-0">Use the search box in the top-right to enter a Customer ID. The dashboard will populate with their KPIs, alerts and trends.</p>
      </div>
      <div class="text-muted small">No customer selected</div>
    </div>
  </div>
{% else %}

<!-- Filters row: Period -->
<form method="get" action="{{ url_for('dashboard') }}" class="row g-2 align-items-end mb-3">
  <input type="hidden" name="customer_id" value="{{ filter_meta.customer_id }}">
  <div class="col-auto">
    <label class="form-label">Period</label>
    <select name="period" class="form-select">
      <option value="all"  {{ 'selected' if selected_period=='all' else '' }}>All time</option>
      <option value="3m"   {{ 'selected' if selected_period=='3m' else '' }}>Last 3 months</option>
      <option value="6m"   {{ 'selected' if selected_period=='6m' else '' }}>Last 6 months</option>
      <option value="12m"  {{ 'selected' if selected_period=='12m' else '' }}>Last 12 months</option>
      <option value="ytd"  {{ 'selected' if selected_period=='ytd' else '' }}>Year to date</option>
      <optgroup label="Specific month">
        {% for m in months %}
          <option value="month:{{ m }}" {{ 'selected' if selected_period=='month:' + m else '' }}>
            {{ m }}
          </option>
        {% endfor %}
      </optgroup>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-primary mt-4">Apply</button>
    <a class="btn btn-outline-secondary mt-4" href="{{ url_for('dashboard', customer_id=filter_meta.customer_id) }}">
      Clear period
    </a>
  </div>
</form>

<!-- KPI tiles (clickable) -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <a class="text-decoration-none" href="{{ url_for('explore', customer_id=filter_meta.customer_id) }}">
      <div class="card kpi"><div class="card-body">
        <div class="kpi-label">Total Money In</div>
        <div class="kpi-value">£{{ "{:,.2f}".format(tiles.total_in or 0) }}</div>
      </div></div>
    </a>
  </div>
  <div class="col-md-3">
    <a class="text-decoration-none" href="{{ url_for('explore', direction='out', customer_id=filter_meta.customer_id) }}">
      <div class="card kpi"><div class="card-body">
        <div class="kpi-label">Total Money Out</div>
        <div class="kpi-value">£{{ "{:,.2f}".format(tiles.total_out or 0) }}</div>
      </div></div>
    </a>
  </div>
  <div class="col-md-3">
    <a class="text-decoration-none" href="{{ url_for('explore', channel='cash', direction='in', customer_id=filter_meta.customer_id) }}">
      <div class="card kpi"><div class="card-body">
        <div class="kpi-label">Total Cash Deposits</div>
        <div class="kpi-value">£{{ "{:,.2f}".format(tiles.cash_in or 0) }}</div>
      </div></div>
    </a>
  </div>
  <div class="col-md-3">
    <a class="text-decoration-none" href="{{ url_for('explore', channel='cash', direction='out', customer_id=filter_meta.customer_id) }}">
      <div class="card kpi"><div class="card-body">
        <div class="kpi-label">Total Cash Withdrawals</div>
        <div class="kpi-value">£{{ "{:,.2f}".format(tiles.cash_out or 0) }}</div>
      </div></div>
    </a>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-6">
    <a class="text-decoration-none"
       href="{{ url_for('explore', risk='HIGH,HIGH_3RD,PROHIBITED', customer_id=filter_meta.customer_id) }}">
      <div class="card kpi"><div class="card-body">
        <div class="kpi-label">Payments to High/High-3rd/Prohibited</div>
        <div class="kpi-value">
          £{{ "{:,.2f}".format(tiles.high_risk_total or 0) }}
        </div>
      </div></div>
    </a>
  </div>
  <div class="col-md-6">
    <div class="card kpi"><div class="card-body">
      <div class="kpi-label">Critical Alerts</div>
      <div class="kpi-value">{{ "{:,}".format(kpis.critical or 0) }}</div>
    </div></div>
  </div>
</div>

<!-- Charts -->
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header fw-semibold">
        Alerts Over Time — {{ filter_meta.customer_id }}
      </div>
      <div class="card-body" style="height: 260px;">
        <canvas id="alertsOverTime"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header fw-semibold">
        Top Countries (alerts) — {{ filter_meta.customer_id }}
      </div>
      <div class="card-body">
        <ol class="mb-0">
          {% for row in top_countries %}
          <li>{{ row.name or 'Unknown' }} — {{ row.cnt }}</li>
          {% else %}
          <li>No data</li>
          {% endfor %}
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Reviewer metrics -->
<div class="card mt-4 mb-2">
  <div class="card-header fw-semibold">Reviewer Metrics</div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">Avg Cash Deposits</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.avg_cash_deposits or 0) }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">Avg Cash Withdrawals</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.avg_cash_withdrawals or 0) }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">Avg Payment In</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.avg_in or 0) }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">Avg Payment Out</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.avg_out or 0) }}</div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">Highest Payment In</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.max_in or 0) }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">Highest Payment Out</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.max_out or 0) }}</div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">Overseas Transactions (Value)</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.overseas_value or 0) }}</div>
          <div class="text-muted small">{{ "{:.1f}%".format(metrics.overseas_pct or 0) }} of total</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-3 h-100">
          <div class="text-muted small">High/High-3rd/Prohibited (Value)</div>
          <div class="fs-5 fw-semibold">£{{ "{:,.2f}".format(metrics.highrisk_value or 0) }}</div>
          <div class="text-muted small">{{ "{:.1f}%".format(metrics.highrisk_pct or 0) }} of total</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header fw-semibold">
        Monthly Money In vs Out — {{ filter_meta.customer_id }}
      </div>
      <div class="card-body" style="height: 300px;">
        <canvas id="monthlyInOut"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  function withCommas(value) {
    if (value === null || value === undefined) return '';
    return value.toLocaleString();
  }

  function drawCharts() {
    if (typeof Chart === 'undefined') return;

    // Alerts over time
    const aot = document.getElementById('alertsOverTime');
    const labels = {{ (labels|default([]))|tojson }};
    const values = {{ (values|default([]))|tojson }};
    if (aot && labels && labels.length) {
      new Chart(aot, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Alerts', data: values, tension: 0.3 }]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: (val) => withCommas(val) }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${withCommas(ctx.parsed.y)}`
              }
            }
          }
        }
      });
    }

    // Monthly in/out
    const mio = document.getElementById('monthlyInOut');
    const tLabels = {{ (trend_labels|default([]))|tojson }};
    const tIn = {{ (trend_in|default([]))|tojson }};
    const tOut = {{ (trend_out|default([]))|tojson }};
    if (mio && tLabels && tLabels.length) {
      new Chart(mio, {
        type: 'line',
        data: {
          labels: tLabels,
          datasets: [
            { label: 'Money In', data: tIn, tension: 0.3 },
            { label: 'Money Out', data: tOut, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: (val) => '£' + withCommas(val) }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: £${withCommas(ctx.parsed.y)}`
              }
            }
          }
        }
      });
    }
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(drawCharts, 0);
  } else {
    document.addEventListener('DOMContentLoaded', drawCharts);
  }
</script>
{% endif %}
{% endblock %}