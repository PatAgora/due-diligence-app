{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">User Management</h2>

  <form method="get" class="mb-3 d-flex flex-wrap align-items-center gap-2">
    <label class="form-label me-2">Sort by Last Active:</label>
    <select name="sort" class="form-select w-auto">
      <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Most Recent</option>
      <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Least Recent</option>
    </select>

    <label class="form-label ms-4 me-2">Inactive for more than:</label>
    <select name="inactive_days" class="form-select w-auto">
      <option value="">--</option>
      <option value="7" {% if inactive_days == '7' %}selected{% endif %}>7 days</option>
      <option value="14" {% if inactive_days == '14' %}selected{% endif %}>14 days</option>
      <option value="30" {% if inactive_days == '30' %}selected{% endif %}>30 days</option>
    </select>

    <button type="submit" class="btn btn-primary">Apply</button>
    <a href="{{ url_for('list_users') }}" class="btn btn-secondary">Reset</a>
  </form>

  <a href="{{ url_for('create_user') }}" class="btn btn-success mb-3">Create New User</a>

  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Reporting Line</th>
        <th>Last Active</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr {% if user.last_active is none or (user.last_active and (user.last_active | to_datetime).date() <= (now() - timedelta(days=7)).date()) %}class="table-warning"{% endif %}>
        <td>{{ user.name or '-' }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.role | friendly_role }}</td>
        <td>{{ user.team_lead or '-' }}</td>
        <td>{{ user.last_active or '-' }}</td>
        <td>
          <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-sm btn-primary">Edit</a>
          <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}