{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">QC Sampling Rates</h2>

  <!-- Add / Update Sampling Rate Form -->
  <form method="POST" class="row g-3 mb-4 needs-validation" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="col-md-4">
      <label for="reviewer_id" class="form-label">Reviewer</label>
      <select class="form-select" name="reviewer_id" id="reviewer_id">
        <option value="">-- Global (for Level) --</option>
        {% for reviewer in reviewers %}
          <option value="{{ reviewer.id }}">{{ reviewer.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label for="level" class="form-label">Level</label>
      <select class="form-select" name="level" id="level" required>
        <option value="1">Level 1</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
      </select>
    </div>

    <div class="col-md-2">
      <label for="rate" class="form-label">Sampling Rate (%)</label>
      <input type="number" class="form-control" name="rate" id="rate" min="0" max="100" required>
      <div class="invalid-feedback">Rate must be between 0 and 100</div>
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-success w-100">Add / Update</button>
    </div>
  </form>

  <!-- Sampling Rate Table -->
  <table class="table table-bordered table-hover">
    <thead class="table-dark">
      <tr>
        <th>Reviewer</th>
        <th>Level</th>
        <th>Sampling Rate (%)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for rate in rates %}
      <tr>
        <td>{{ rate.reviewer_name or '-- Global --' }}</td>
        <td>{{ rate.level }}</td>
        <td>
          <form method="POST" action="{{ url_for('sampling_rates') }}" class="d-flex align-items-center needs-validation" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="reviewer_id" value="{{ rate.reviewer_id }}">
            <input type="hidden" name="level" value="{{ rate.level }}">
            <input type="number" name="rate" class="form-control form-control-sm me-2" value="{{ rate.rate }}" min="0" max="100" required>
            <div class="invalid-feedback">Rate must be between 0 and 100</div>
            <button type="submit" class="btn btn-sm btn-primary">Update</button>
          </form>
        </td>
        <td>
          <form method="POST" onsubmit="return confirmDelete(this);" action="{{ url_for('delete_sampling_rule', reviewer_id=rate.reviewer_id or 'null', level=rate.level) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Missing Rule Warning -->
  {% if missing_reviewers %}
  <div class="mt-4">
    <span class="text-warning fw-bold">&#x1F7E1; Reviewers Missing a Rule (Default to 100%)</span>
    <ul class="mt-2">
      {% for reviewer in missing_reviewers %}
      <li>{{ reviewer.name }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" id="deleteForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteLabel">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this sampling rule?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- JS for real-time validation + delete confirmation -->
<script>
function confirmDelete(form) {
  const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
  const deleteForm = document.getElementById('deleteForm');
  deleteForm.action = form.action;
  modal.show();
  return false;
}

document.addEventListener('DOMContentLoaded', function () {
  const rateInputs = document.querySelectorAll('input[name="rate"]');
  rateInputs.forEach(input => {
    input.addEventListener('input', () => {
      const value = parseFloat(input.value);
      if (isNaN(value) || value < 0 || value > 100) {
        input.classList.add('is-invalid');
      } else {
        input.classList.remove('is-invalid');
      }
    });
  });
});
</script>
{% endblock %}