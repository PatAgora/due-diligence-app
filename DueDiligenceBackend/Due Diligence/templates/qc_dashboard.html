{% extends "base.html" %}
{% block content %}
<div class="container my-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="fw-bold mb-0">My QC Dashboard (Level {{ level }})</h1>
  </div>

  <!-- Filters -->
  <form method="get" class="row g-2 mb-4 align-items-center">
    <div class="col-auto">
      <select name="date_range" class="form-select form-select-sm">
        {% for dr in date_ranges %}
          <option value="{{ dr.value }}" {% if dr.value == selected_date %}selected{% endif %}>{{ dr.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary btn-sm">Apply</button>
    </div>
  </form>

  <!-- KPI Row -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-md-3">
      <div class="card text-center p-4 shadow-sm">
        <h6>My Active WIP</h6>
        <div class="display-6 text-primary">{{ active_wip|default(0) }}</div>
        <small class="text-muted">Assigned to me, not finished</small>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="card text-center p-4 shadow-sm">
        <h6>Completed</h6>
        <div class="display-6 text-primary">{{ completed_in_range|default(0) }}</div>
        <small class="text-muted">Within selected period</small>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="card text-center p-4 shadow-sm">
        <h6>Outstanding Reworks</h6>
        <div class="display-6 text-primary">{{ outstanding_reworks|default(0) }}</div>
        <small class="text-muted">Rework required, not completed</small>
      </div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="card text-center p-4 shadow-sm">
        <h6>QC Pass %</h6>
        <div class="display-6 text-primary">{{ qc_pass_pct|default(0) }}%</div>
        <small class="text-muted">Sample: {{ qc_sample|default(0) }}</small>
      </div>
    </div>
  </div>

  <!-- Charts + Recent -->
  <div class="row g-4 mb-4 align-items-stretch">
    <div class="col-lg-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex flex-column align-items-center">
          <h5 class="card-title">My QC Outcomes</h5>
          {% if qc_sample|default(0) > 0 %}
            <div id="qcOutcomeChart" style="height:220px; width:220px;"></div>
            <p class="mt-2 text-muted small">Pass rate for selected period</p>
          {% else %}
            <div class="flex-fill d-flex align-items-center justify-content-center">
              <span class="text-muted">No outcomes in the selected period.</span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Recent Completions</h5>
          <div class="table-responsive" style="max-height:260px; overflow:auto;">
            <table class="table table-striped table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>Task</th>
                  <th class="text-end">QC End</th>
                </tr>
              </thead>
              <tbody>
                {% if recent and recent|length %}
                  {% for r in recent %}
                  <tr>
                    <td>
                      <a href="{{ url_for('reviewer_panel', task_id=r.task_id) if r.task_id else '#' }}">
                        {{ r.task_id }}
                      </a>
                    </td>
                    <td class="text-end">{{ r.qc_end or '—' }}</td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="2" class="text-center text-muted">No recent completions.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- My WIP -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">My WIP</h5>
      <div class="table-responsive">
        <table class="table table-striped table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Task</th>
              <th style="width:170px;">QC Start</th>
              <th style="width:160px;">Rework</th>
            </tr>
          </thead>
          <tbody>
            {% if my_wip_rows and my_wip_rows|length %}
              {% for r in my_wip_rows %}
              <tr>
                <td>
                  <a href="{{ url_for('reviewer_panel', task_id=r.task_id) if r.task_id else '#' }}">
                    {{ r.task_id }}
                  </a>
                </td>
                <td>{{ r.qc_start or '—' }}</td>
                <td>
                  {% if r.rework_required %}
                    <span class="badge text-bg-danger">Required</span>
                    {% if r.rework_completed %}<span class="badge text-bg-success ms-1">Completed</span>{% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="3" class="text-center text-muted">No items in your WIP.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
{% if qc_sample|default(0) > 0 %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const passPct = parseFloat("{{ qc_pass_pct|default(0) }}");
    Plotly.newPlot("qcOutcomeChart", [{
      values: [passPct, 100 - passPct],
      labels: ['Pass','Fail/Other'],
      type: 'pie',
      hole: 0.5
    }], {
      height: 260, width: 260,
      margin: {t:10, b:0, l:0, r:0},
      showlegend: true,
      legend: {orientation:'h', x:0.5, xanchor:'center', y:-0.2}
    });
  });
</script>
{% endif %}
{% endblock %}