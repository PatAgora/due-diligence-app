{% extends "base.html" %}
{% block content %}
<div class="review-panel">
    <div class="review-header">
        <h2><strong>Review Panel – Level {{ review.level or 'N/A' }}</strong></h2>
        <div class="review-info">
            <p><strong>Task ID:</strong> {{ review.task_id }}</p>
            <p><strong>Status:</strong> {{ review.status }}</p>
            <p><strong>Reviewer:</strong> {{ reviewer_name or 'Unassigned' }}</p>
            <p><strong>Score:</strong> {{ match.total_score if match and 'total_score' in match else 'N/A' }}</p>
        </div>
    </div>

    <!-- Watchlist Section -->
    <div class="comparison-table">
        <h3>Watchlist Record</h3>
        <table>
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for field, value in watchlist_fields %}
                <tr>
                    <td>{{ field.replace('_', ' ') | title }}</td>
                    <td><textarea readonly class="readonly-cell">{{ value if value else "—" }}</textarea></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Record Section -->
    <div class="comparison-table">
        <h3>{{ record_type }} Record</h3>
        <table>
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for field, value in dynamic_fields %}
                <tr>
                    <td>{{ field.replace('_', ' ') | title }}</td>
                    <td><textarea readonly class="readonly-cell">{{ value if value else "—" }}</textarea></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Match Details -->
   <div class="review-actions">
    <div class="form-group">
        <label>Match Explanation</label>
        <textarea readonly class="readonly-cell">{{ match.match_explanation if match else 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>Match Probability</label>
        <textarea readonly class="readonly-cell">{{ match.match_probability if match else 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>Match Type</label>
        <textarea readonly class="readonly-cell">{{ match.match_type if match else 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>Rationale Tags</label>
        <textarea readonly class="readonly-cell">{{ review.rationale_tags or 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>System Rationale</label>
        <textarea readonly class="readonly-cell">{{ system_rationale or 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>Primary Rationale</label>
        <textarea readonly class="readonly-cell">{{ review.primary_rationale or 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>Decision Rationale</label>
        <textarea readonly class="readonly-cell">{{ review.rationale or 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>SME Advice</label>
        <textarea readonly class="readonly-cell">{{ review.sme_advice or 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>QC Comment</label>
        <textarea readonly class="readonly-cell">{{ review.qc_comment or 'N/A' }}</textarea>
    </div>
    <div class="form-group">
        <label>Reviewed At</label>
        <p>{{ review.updated_at or 'N/A' }}</p>
    </div>
</div>

    
    <!-- Customer Details (minimal addition) -->
    <div class="comparison-table" id="customer-details">
        <h3>Customer Details</h3>
        <div class="form-group">
            <label for="current_risk_rating"><strong>Current Risk Rating</strong></label>
            <input type="text" id="current_risk_rating" name="current_risk_rating" value="{{ review.currentriskrating or '' }}" placeholder="Enter current risk rating...">
        </div>
    </div>

    <!-- Due Diligence Section (updated as requested) -->
    <div class="comparison-table" id="due-diligence">
        <h3>Due Diligence - Data Gather</h3>

        <!-- Table 1 -->
        <table>
            <thead>
                <tr>
                    <th>Section</th>
                    <th>Rationale</th>
                    <th>Verified</th>
                    <th>Certified</th>
                    <th>Satisfied</th>
                </tr>
            </thead>
            <tbody>
                {% set dd_sections = [
                    'Incorporation Documentation',
                    'Companies House Registration',
                    'Trading Name',
                    'Registered Address',
                    'Presence in HRJ',
                    'Ownership Structure',
                    'UBO details',
                    'SIC Code',
                    'Nature of Business',
                    'Expected Annual Turnover',
                    'SoF',
                    'SoW',
                    'ID&V',
                    'Transaction Monitoring Assessment',
                    'Is Activity inline with expectations',
                    'Screening',
                    'Trigger Event Found'
                ] %}
                {% for label in dd_sections %}
                <tr>
                    <td><input type="text" readonly class="readonly-cell" value="{{ label }}"></td>
                    <td><textarea name="dd_rationale_{{ loop.index }}" placeholder="Enter rationale...">{{ (dd_rows[loop.index0].rationale if dd_rows and loop.index0 < dd_rows|length else '') }}</textarea></td>
                    <td class="checkbox-cell"><input type="checkbox" name="dd_verified_{{ loop.index }}" {% if dd_rows and loop.index0 < dd_rows|length and dd_rows[loop.index0].verified %}checked{% endif %}></td>
                    <td class="checkbox-cell"><input type="checkbox" name="dd_certified_{{ loop.index }}" {% if dd_rows and loop.index0 < dd_rows|length and dd_rows[loop.index0].certified %}checked{% endif %}></td>
                    <td class="checkbox-cell"><input type="checkbox" name="dd_satisfied_{{ loop.index }}" {% if dd_rows and loop.index0 < dd_rows|length and dd_rows[loop.index0].satisfied %}checked{% endif %}></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Table 2 -->
        <div class="mt-3"></div>
        <table>
            <thead>
                <tr>
                    <th>FinCrime Concerns</th>
                    <th>Rationale</th>
                    <th>Date Raised</th>
                </tr>
            </thead>
            <tbody>
                {% set fcc_rows = ['SAR','DAML'] %}
                {% for label in fcc_rows %}
                <tr>
                    <td><input type="text" readonly class="readonly-cell" value="{{ label }}"></td>
                    <td><textarea name="fcc_rationale_{{ loop.index }}" placeholder="Enter rationale...">{{ (fincrime_rows[loop.index0].rationale if fincrime_rows and loop.index0 < fincrime_rows|length else '') }}</textarea></td>
                    <td><input type="date" name="fcc_date_{{ loop.index }}" value="{{ (fincrime_rows[loop.index0].date_raised if fincrime_rows and loop.index0 < fincrime_rows|length else '') }}"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- No save button in this section by request -->
    </div>

    <!-- Decision Section -->
    <div class="comparison-table" id="decision">
        <h3>Decision</h3>
        <div class="form-group">
            <label for="case_summary"><strong>Case Summary</strong></label>
            <textarea id="case_summary" name="case_summary" placeholder="Summarise the case...">{{ review.primary_rationale or '' }}</textarea>
        </div>
        <div class="form-group">
            <label for="outcome"><strong>Outcome</strong></label>
            <select id="outcome" name="outcome">
                {% for opt in outcome_options or ['Discount','True Match'] %}
                <option value="{{ opt }}" {% if review['l' ~ level ~ '_outcome'] == opt or (review.outcome == opt) %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="rationale"><strong>Decision Rationale</strong></label>
            <textarea id="rationale" name="rationale" placeholder="Explain the decision...">{{ review.rationale or '' }}</textarea>
        </div>
    </div>


<style>
.review-panel {
    padding: 20px;
    font-family: Arial, sans-serif;
}
.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.review-info p {
    margin: 4px 0;
    font-size: 14px;
}
.comparison-table {
    margin-bottom: 25px;
}
.comparison-table table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}
.comparison-table th, .comparison-table td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
    vertical-align: top;
}
.comparison-table th:first-child,
.comparison-table td:first-child {
    width: 25%;
    white-space: nowrap;
}
.comparison-table th:last-child,
.comparison-table td:last-child {
    width: 75%;
}
.comparison-table th {
    background-color: #f2f2f2;
}
textarea.readonly-cell {
    width: 100%;
    min-height: 24px;
    resize: vertical;
    border: 1px solid #ccc;
    padding: 6px;
    font-family: inherit;
    font-size: 13px;
    line-height: 1.3;
    background-color: #f9f9f9;
    color: #333;
    box-sizing: border-box;
}
.review-details p {
    margin: 8px 0;
    font-size: 14px;
}

/* Due Diligence section specific (scoped by #due-diligence) */
#due-diligence .checkbox-cell { text-align: center; vertical-align: middle; width: 110px; }
#due-diligence input[type="text"] { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 13px; }
#due-diligence textarea { width: 100%; min-height: 48px; resize: vertical; border: 1px solid #ccc; padding: 6px; font-family: inherit; font-size: 13px; }
#due-diligence .muted-note { color: #6c757d; font-size: 12px; margin-top: 8px; }

#customer-details input[type="text"],
#decision select,
#decision textarea,
#customer-details textarea,
#due-diligence input[type='date']{
    width: 100%;
    box-sizing: border-box;
    padding: 6px;
    border: 1px solid #ccc;
    font-family: inherit;
    font-size: 13px;
}
.mt-3 { margin-top: 12px; }

</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    try {
      const dashUrl = "{{ url_for('reviewer_dashboard') }}";
      function makeItem(text, href) {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const a = document.createElement('a');
        a.className = 'nav-link';
        a.href = href;
        a.textContent = text;
        li.appendChild(a);
        return li;
      }
      const candidateLists = document.querySelectorAll('#sidebar-nav ul, nav .navbar-nav, .sidebar .nav, .navbar-nav');
      candidateLists.forEach(function(ul) {
        try { ul.appendChild(makeItem('Dashboard', dashUrl)); } catch(err) {}
      });
    } catch (e) {
      // ignore
    }
  });
</script>

{% endblock %}